# VR Fire Visualization

## Prerequisites
Newer or older versions of the listed prerequisites may also work.
- Unity 2022.3.15f1 
- Python 3.11.9
- [FDSReader](https://pypi.org/project/fdsreader/) 1.10.2
- [NumPy](https://numpy.org/) 1.26.2

## Installation
Clone the repository and open the Unity project from the Unity Hub

## Preprocessing a simulation
Three steps are required to visualize a simulation. Two preprocessing steps using python scripts and finally, the visualization.

### Extracting data
After cloning the repository, go into the Misc directory. From there, run the fdstoraw3.py script, it will then ask for a simulation directory. You can manually input the path to your simulation, but most consoles will also input the path to a file if you drag and drop it into the terminal window.
![imagen](https://github.com/Sokdenumeros/FireSimulation/assets/61268710/127345ff-ab54-46df-b31d-86fe3b20f514)
![imagen](https://github.com/Sokdenumeros/FireSimulation/assets/61268710/e1857e16-24ea-441e-a79a-9ca60a0f3c44)

This should create two directories named SOOTDENSITY and HRPUV with many files in them. If the names of the directories do not match the information you wanted to extratct, make sure that the fields of the simulation being accessed in the last lines of the fdstoraw3.py script are the correct ones.

![imagen](https://github.com/Sokdenumeros/FireSimulation/assets/61268710/02ada54e-af94-460e-95f5-56193ba64e90)

If you get the following error message:
numpy.core._exceptions._ArrayMemoryError: Unable to allocate 112. GiB for an array with shape (398, 641, 293, 201) and data type float16
This means that your system does not have enough RAM to store the entire simulation. Try [increasing the Virtual Memory](https://support.esri.com/en-us/knowledge-base/increase-virtual-memory-beyond-the-recommended-maximum--000011346) to around 1.5x the ammount requested by the error. 112. GiB -> 150000 MB

### Randomly selecting particles

If you had to increase the Virtual memory in the previous section, you can already go back to "Automatically manage paging file size for all drives".

Run rawtoparticles.py, it will ask for the smoke and heat directories. Similar to the previous section, you can manually write the path to each one or drag and drop the directories. The script will extract a random subsample of the data into the 'particles' and 'partData' directories.

![imagen](https://github.com/Sokdenumeros/FireSimulation/assets/61268710/ed15f2fb-968d-4ced-8361-cecbfb6b5fc9)

In the first lines of the script, it is possible to adjust four parameters:
| Variable Name |  Description  |
|:---:|----------|
| nparticles  | Maximum number of particles that can be extracted from a single time instant.|
| opacityThreshold | Particles with a SootDensity below the threshold will be excluded from the list of potential particles to be selected.|
| heatThreshold | Particles with a HRPUV below the threshold will be excluded from the list of potential fire particles to be selected. |
| smokeparticlesratio | Max fraction from the total number of nparticles that can be smoke particles (soot > opacityThreshold & HRPUV < heatThreshold) |

## Visualization
In order to visualize a simulation, it first needs to be preprocessed as explained in the previous section.

Open the desired Unity scene, 2D_template or VR_template. In both you will see a SimulationManager object with one SimulationManager script, two ByteLoader scripts and a DisableFrustrumCulling script.

![SimManager](https://github.com/Sokdenumeros/FireSimulation/assets/61268710/3c0df5ef-1bd6-45af-a8eb-eef9d90eecc3)

**SimulationManager parameters:**
| Parameter name |  Description  |
|:---:|----------|
| Gridx/y/z File  | Path to the grid files, those are generated inside each of the directories generated by fdstoraw3.py |
| nparticles | Max number of particles that the visualization will display per time step (should match the nparticles value from rawtoparticles.py) |
| particle size | Scale factor to apply to the particle. Bigger particles will result in worse performance. |
| Opacityfactor | Scalar factor that multiplies the final opacity of the particles. |
| Tfmin | min control point for the HRRPUV transfer function, below this value all particles will be black. |
| Tfmin | max control point for the HRRPUV transfer function, above this value all particles will be orange. |

**ByteLoader parameters:**
| Parameter name |  Description  |
|:---:|----------|
| pre  | Path to a file inside the preprocessed data directories up until the timestamp starts. ie. "_Simulations/particles/T~0.0.raw~_" |
| post | Last part of the file path, after the timestamp. ie. "_~Simulations/particles/T0.0~.raw_" |
| timestep | Frequency in which new data will be loaded in seconds. Performance should be fine at least until 0.05 seconds but make sure to use an SSD|

Once all the parameters have been configured, click the play button to run it.

## VR visualization
In order to visualize it in virtual reality, connect the headset to the computer using meta quest link or similar depending on the headset model/manufacturer.

When running the VR_template scene it should automatically show up on the headset.

### Controls
The following controls have been implemented for the Meta Quest 3, different headsets may have other input mappings.
| VR Controller Key |  Action  |
|:---:|----------|
| Left Joystick | Move horizontally |
| Left Front Trigger | Move upwards |
| Left Lateral Trigger | Move downwards |

## Extra
simulationinfo.py and binaryinfo.py scripts in the Misc directory can be used to quickly check details of an original fds simulation directory or a .raw soot or hrpuv file. This can be useful to see which data fields are stored in a simulation and in which order, or to get an idea of how many cells in the grid have non-zero soot values.
